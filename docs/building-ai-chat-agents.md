# Building AI Chat Agents with `agents-sdk`

This document provides a comprehensive guide to building conversational AI agents using the `AIChatAgent` class from the `agents-sdk`. We'll cover handling chat messages, managing message history, integrating with AI models (like OpenAI), and creating user interfaces for interacting with your AI chat agents.

## Understanding `AIChatAgent`

The `AIChatAgent` class extends the base `Agent` class, providing built-in functionality for managing chat conversations. It simplifies the process of creating AI agents that can engage in natural language dialogues with users.

Key features of `AIChatAgent`:

- **Message Handling:** Provides the `onChatMessage` method for processing incoming chat messages and generating responses.
- **Message History:** Automatically manages a history of chat messages, persisting them in the agent's storage.
- **WebSocket Integration:** Seamlessly integrates with WebSockets for real-time, bidirectional communication.
- **AI Model Integration:** Designed to work with various AI models, such as OpenAI's GPT models.
- **React Hooks:** Provides React hooks for easy integration with chat interfaces.

## Setting up your `AIChatAgent`

First, you'll need to define your `AIChatAgent` class, extending the base class from `agents-sdk`:

```typescript
import { AIChatAgent } from "agents-sdk/ai-chat-agent";

export class MyChatAgent extends AIChatAgent {
  // ... your code here
}
```

Next, configure your `wrangler.toml` file to include your `AIChatAgent`:

```toml
[durable_objects]
bindings = [
  { name = "MyChatAgent", class_name = "MyChatAgent" }
]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["MyChatAgent"]
```

## Handling Chat Messages with `onChatMessage`

The core of your `AIChatAgent` is the `onChatMessage` method. This asynchronous method is triggered whenever a new chat message is received. You _must_ override this method in your derived class.

```typescript
import { AIChatAgent } from "agents-sdk/ai-chat-agent";
import { createOpenAI } from "@ai-sdk/openai";

export class DialogueAgent extends AIChatAgent {
  async onChatMessage(onFinish) {
    return createDataStreamResponse({
      execute: async (dataStream) => {
        const ai = createOpenAI({
          apiKey: this.env.OPENAI_API_KEY,
        });

        const stream = streamText({
          model: ai("gpt-4o"),
          messages: this.messages,
          onFinish, // call onFinish so that messages get saved
        });

        stream.mergeIntoDataStream(dataStream);
      },
    });
  }
}
```

This example demonstrates:

- **Importing necessary modules:** `AIChatAgent` from `agents-sdk/ai-chat-agent` and `createOpenAI` from `@ai-sdk/openai`.
- **Extending `AIChatAgent`:** Creating a `DialogueAgent` class that inherits from `AIChatAgent`.
- **Overriding `onChatMessage`:** Implementing the `onChatMessage` method to handle incoming chat messages.
- **Integrating with OpenAI:** Using `createOpenAI` to connect to the OpenAI API.
- **Streaming responses:** Utilizing `createDataStreamResponse` and `streamText` to stream the AI's response back to the client.
- **Calling `onFinish`:** Ensuring that the `onFinish` callback is called to save the messages to the agent's history.

## Understanding `createDataStreamResponse` and `streamText`

`createDataStreamResponse` and `streamText` are helper functions (typically from the `ai` or `@ai-sdk/openai` libraries) that facilitate streaming responses from AI models. Streaming allows you to send the AI's response to the client as it's being generated, improving the user experience.

- **`createDataStreamResponse`:** This function creates a `Response` object that can be streamed to the client. It takes an `execute` function as an argument, which is responsible for generating the data stream.
- **`streamText`:** This function (often provided by an AI SDK) takes the AI model, messages, and an `onFinish` callback as arguments. It returns a readable stream of text generated by the AI model. The `onFinish` callback is crucial for saving the messages to the agent's history after the AI has finished generating the response.

## Managing Chat History

The `AIChatAgent` automatically manages the chat history for each conversation. The `messages` property contains an array of `ChatMessage` objects, representing the current conversation. These messages are persisted in the agent's storage, ensuring that the conversation history is maintained across sessions.

To clear the chat history, you can use the `clearHistory` method in your React component (see below).

## Creating a Chat Interface with React

The `agents-sdk` provides React hooks that simplify the process of creating chat interfaces for your AI agents. The `useAgentChat` hook handles the complexities of managing chat state, sending messages, and receiving responses.

Here's an example of how to use the `useAgentChat` hook:

```tsx
import { useAgent } from "agents-sdk/react";
import { useAgentChat } from "agents-sdk/ai-react";

function ChatInterface() {
  // Connect to the agent
  const agent = useAgent({
    agent: "dialogue-agent",
  });

  // Set up the chat interaction
  const { messages, input, handleInputChange, handleSubmit, clearHistory } =
    useAgentChat({
      agent,
      maxSteps: 5,
    });

  return (
    <div className="chat-interface">
      {/* Message History */}
      <div className="message-flow">
        {messages.map((message) => (
          <div key={message.id} className="message">
            <div className="role">{message.role}</div>
            <div className="content">{message.content}</div>
          </div>
        ))}
      </div>

      {/* Input Area */}
      <form onSubmit={handleSubmit} className="input-area">
        <input
          value={input}
          onChange={handleInputChange}
          placeholder="Type your message..."
          className="message-input"
        />
      </form>

      <button onClick={clearHistory} className="clear-button">
        Clear Chat
      </button>
    </div>
  );
}
```

This example demonstrates:

- **Importing necessary hooks:** `useAgent` from `agents-sdk/react` and `useAgentChat` from `agents-sdk/ai-react`.
- **Connecting to the agent:** Using `useAgent` to establish a connection with the `dialogue-agent`.
- **Using `useAgentChat`:** Configuring the `useAgentChat` hook with the agent connection and other options, such as `maxSteps` to limit the number of turns in the conversation.
- **Rendering the message history:** Mapping over the `messages` array to display the chat history.
- **Creating an input area:** Using the `input`, `handleInputChange`, and `handleSubmit` properties from `useAgentChat` to create a form for sending messages.
- **Adding a clear history button:** Using the `clearHistory` function to clear the chat history on both the client and the agent.

## Key Takeaways

- `AIChatAgent` simplifies the creation of conversational AI agents.
- Override `onChatMessage` to handle incoming messages and generate responses.
- Use `createDataStreamResponse` and `streamText` for streaming responses from AI models.
- The `messages` property automatically manages the chat history.
- The `useAgentChat` hook simplifies the creation of React chat interfaces.

By following these guidelines, you can leverage the `agents-sdk` to build powerful and engaging AI chat agents.
